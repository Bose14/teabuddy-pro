rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isValidDate(dateStr) {
      return dateStr is string && dateStr.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }
    
    function isValidNumber(num) {
      return num is number && num >= 0;
    }
    
    // Daily Cash Flow Collection
    match /dailyCashFlow/{docId} {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasAll([
        'date', 'yesterday_cash', 'cash_sales', 'online_sales', 
        'closing_cash', 'cash_expenses', 'online_expenses', 'total_expenses'
      ])
      && isValidDate(request.resource.data.date)
      && isValidNumber(request.resource.data.yesterday_cash)
      && isValidNumber(request.resource.data.cash_sales)
      && isValidNumber(request.resource.data.online_sales)
      && isValidNumber(request.resource.data.closing_cash);
      allow delete: if true;
    }
    
    // Expenses Collection
    match /expenses/{docId} {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasAll([
        'date', 'expense_type', 'amount', 'payment_method', 'is_salary_payment'
      ])
      && isValidDate(request.resource.data.date)
      && isValidNumber(request.resource.data.amount)
      && request.resource.data.payment_method in ['Cash', 'Online']
      && request.resource.data.is_salary_payment is bool;
      allow delete: if true;
    }
    
    // Employees Collection
    match /employees/{docId} {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasAll([
        'name', 'role', 'monthly_salary', 'advance_given', 'is_active'
      ])
      && isValidNumber(request.resource.data.monthly_salary)
      && isValidNumber(request.resource.data.advance_given)
      && request.resource.data.is_active is bool;
      allow delete: if false; // Don't allow deleting employees
    }
    
    // Salary Payments Collection
    match /salaryPayments/{docId} {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasAll([
        'employee_id', 'amount', 'payment_method', 'month', 'year'
      ])
      && isValidNumber(request.resource.data.amount)
      && request.resource.data.payment_method in ['Cash', 'Online']
      && request.resource.data.year is number;
      allow delete: if true;
    }
    
    // Stock Collection
    match /stock/{docId} {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasAll([
        'product_name', 'category', 'unit', 'opening_stock',
        'purchase_price', 'selling_price', 'low_stock_threshold'
      ])
      && isValidNumber(request.resource.data.opening_stock)
      && isValidNumber(request.resource.data.purchase_price)
      && isValidNumber(request.resource.data.selling_price)
      && isValidNumber(request.resource.data.low_stock_threshold);
      allow delete: if true;
    }
    
    // Stock Transactions Collection
    match /stockTransactions/{docId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll([
        'stock_id', 'transaction_type', 'quantity'
      ])
      && request.resource.data.transaction_type in ['purchase', 'use']
      && isValidNumber(request.resource.data.quantity);
      allow update: if false; // Transactions are immutable (no editing)
      allow delete: if true; // Allow deletion when parent stock is deleted
    }
    
    // Stock Analytics Collection (computed data)
    match /stockAnalytics/{docId} {
      allow read: if true;
      allow write: if true; // Allow Cloud Functions to update
    }
  }
}
